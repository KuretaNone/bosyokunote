---
id: GitHub Actionsでデプロイを自動化する
aliases:
  - GitHub Actionsでデプロイを自動化する
tags: []
created: "2025-06-25"
updated: "2025-07-04"
---

# GitHub Actionsでデプロイを自動化する
## カスタムドメインのサイトの更新を自動化した～～～い‼
ということで、[[GitHub Actions]]を使って、サイトのデプロイを自動化する方法について説明します。  
この辺のネタって死ぬほどこすられてるから、あまり需要はないかもしれませんが、いいんです。
自分で調べて、やってみたいから、やる。そういうものです。

> [!NOTE]
> カスタムドメインを取得していなくても、[[GitHub Pages]]を使ってサイトを公開することはできます。
> その場合は接続先のドメインが`<username>.github.io`のような形になります。

## 前提の環境
- 独自ドメインを取得している
- [[GitHub]]にリポジトリを作成している
- [[MkDocs]]を使ってサイトを作成している
- [[Material for MkDocs]]を使ってサイトを作成している

## GitHub Actionsって何？
[[CI]]/[[CD]]のプラットフォームで、[[リポジトリ]]に対して、ちょっとコードを管理、提供していくうえで便利な機能が集まってます！

## 自分のサイトの更新について
自分のサイトは[[MkDocs]]を使って作成しています。  
概要自体は[[MkDocsを使ってサイトを作る]]に書いています。  

ステップだけで言うと以下のような流れです。

1. [[MkDocs]]で記事や[[PKM]]を作成
1. 作成した[[Markdown]]を`mkdocs build`コマンドでビルド
2. `site`ディレクトリに出力された[[HTML]]ファイルを[[WinScp]]を使って[[サーバー]]にアップロード

ここでめんどくさいのが、毎回手動でビルドして、アップロードすることです。(つまりは全部)  
そして何より、[[Material for MkDocs]]には[[GitHub Actions]]のテンプレートが用意されている(!?)ので、これを使わない手はないです。

> [!NOTE]
> [[生き恥をさらす場所を作る]]を執筆していた当時は上記の機能を知らなかったので、手動でビルドしていました。
> ついで言うと今回でデプロイを自動化した際に、契約している[[サーバー]]がいらないことに気づきました。
> 必要なのでドメインの取得だけなので、静的サイトを作るだけなら[[サーバー]]は不要です。[[ドメイン]]だけで十分です。
> やらかしたなぁ...。でもこういう失敗も必要だと思ってます。あるものを使っていきたいのでサーバーは別の何かに使います。
> WordPressとか、いれてインターネット黎明期のようなサイトを作るのも面白いかもしれません。

早速設定をしていきましょう。

## GitHub Pagesの設定

まずは[[GitHub Pages]]の設定を行います。  
[[GitHub Pages]]の設定は、ホストするたリポジトリの`Settings->Pages`から行います。

### Build and deployment
1. `Source`を`Deploy from a branch`に設定します。
2. `Branch`を`gh-pages`に設定します。

### Custom domain
1. `Custom domain`に自分のドメインを入力します。
2. Saveボタンを押します。
2. しばらく待ちます。
3. `Enforce HTTPS`にチェックを入れます。

![1751646994.png](res/1751646994.png)
/// caption
最終的にはこのような感じ
///

## DNSの設定
[[GitHub Pages]]の設定が完了したら、次は[[DNS]]の設定を行います。  

### CNAMEファイルの確認
さっきの設定がうまくできていれば自分のリポジトリに`CNAME`というファイルが作成されているはずです。
> [!NOTE]
> なくてもOK,もしない場合は自分で作成してください。

`CNAME`ファイルにはさっき設定したドメインが記載されているはずです。
    ```txt
    notes.kuretanone.net
    ```
これを`docs`ディレクトリに配置しておきます。

### DNSの設定 
そのドメインを管理している[[DNS]]の設定画面に移動します。  
`CNAME`レコードを追加します。  

[[XServer]]を利用している場合は、以下のように設定します。

| 項目 | 入力内容 |
| --- | --- |
| ホスト名 | notes.kuretanone.net |
| 種別 | CNAME |
| 内容 | KuretaNone.github.io |

![1751646641.png](res/1751646641.png)

## GitHub Actionsの設定
あとちょっとです‼  
先述の通り、[[Material for MkDocs]]には[[GitHub Actions]]を利用して、[[GitHub Pages]]に[[デプロイ]]するための資料([Publishing your site](https://squidfunk.github.io/mkdocs-material/publishing-your-site/))が用意されています。

まずはサイトの通り `.github/workflows/ci.yml`というファイルを作成します。 
サイトに記載している内容をそのままコピペすると、プラグインをインストールするステップが抜けているので、 以下のように修正します。

> [!NOTE]
> ほかにも+マークがついてある部分で、補足が必要なことが書いてあります。(下記もその一つです。)

```diff
- - run: pip install mkdocs-material 
+ - run: pip install --upgrade pip
+ - run: pip install -r requirements.txt
```

事前に、`requirements.txt`というファイルが必要なのですが、これはサイトのbuildに必要なプラグインを記載すればいいです。
[[MkDocsを使ってサイトを作る]]を読んで？作業をしてる人はもうすでにあると思います。

さぁ、 以上の設定をすると、`main`ブランチにプッシュしたときに自動的にMkDocsのビルドが行われます。

ビルドに成功すると、`gh-pages`ブランチにビルドされたサイトがアップロードされます。

> [!NOTE]
> 手動でも`mkdocs gh-deploy`コマンドを実行することで、`gh-pages`ブランチにビルドされたサイトをアップロードすることもできます。

![1751647798.png](res/1751647798.png)

## まとめ

これで、[[GitHub Actions]]を使って、[[MkDocs]]で作成したサイトを[[GitHub Pages]]を利用してカスタムドメインにデプロイすることができるようになりました。  
これにより、サイトの更新が自動化され、手動でビルドやアップロードを行う必要がなくなります。  
プッシュのタイミングによっては、更新途中の記事が公開されたりするデメリットもありますが、(今回の記事はまさにそれ) 

**自動化**という素晴らしい響きがあるので今回は採用を選択しました。

## 裏話
上ではああしろだのこうしろだの言ってますが、実際にやってみるといろいろと問題が出てきます。
何もわからずAIにci.ymlを作成してもらいましたが、うまくいきませんでした。
以下はその格闘記録。

### なに書けばいいかわからんからとりあえずAIに書かせる。
なに書かれたからやっぱりわかんないから、あとでちゃんと読む。

### とりあえずやってみよう。プッシュだプッシュ
プッシュしました。( b1e663b3fb631e57302ef8b090a3855e15155638 )  

### Buildに失敗した
![1751472553.png](res/1751472553.png)  

どうやら失敗したみたいです。
失敗原因は、actions/upload-artifact@v2 という GitHub Actions のアクションが非推奨（サポート終了）になったことが理由です。GitHub公式のアナウンスにも記載されています。
ということで
v3に更新。

![1751473452.png](res/1751473452.png)
また失敗だ！って思ったらこれは依存プラグインが足りないからだ。
なので、`requirements.txt`を更新しました。

```diff
+ mkdocs-material[imaging]
```

> [!NOTE]
> ちゃんと公式サイトのドキュメントを読めばこうはなりません。

### 今度はDeployに失敗した
人生と同じで一個解決したら次の問題が出て来ます。
今度は`Deploy to GitHub Pages`のステップで失敗しました。

### 最後

![1752076409.png](res/1752076409.png)

最終的には上記のように何度もデプロイに失敗しました。
この辺で心が折れて公式ドキュメントをDeeplで翻訳しながらちゃんと読み進めたところ1時間くらいでサクッと解決。あぁ馬鹿らしい。

いつもこんな感じです。公式ドキュメントを読まないから余計時間がかかる。

他にも
- DNSの設定がうまくいかない
- ほかのサイトを見てもAレコードを設定しろといわれるが具体的な値がわからない
等の問題があり、Link to this pageを見てもらえればわかる通り、結構時間がかかりました。(日にちまたいでるのもあるけど)

最終的には、参考リンクを読んで解決したのでやはり信頼できるのは1次情報や、公式のドキュメントですね。  
僕はドキュメントを読めない病気みたいなのにかかっていて、素人のテックブログを読んでしまうことが多いです。  

猛省

## 参考リンク
- https://docs.github.com/ja/actions/about-github-actions/understanding-github-actions
- https://squidfunk.github.io/mkdocs-material/publishing-your-site/
- https://www.mkdocs.org/user-guide/deploying-your-docs/#custom-domains
